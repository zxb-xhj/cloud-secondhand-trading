!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ModdleXML={})}(this,(function(e){"use strict";var t=Object.prototype.toString,n=Object.prototype.hasOwnProperty;function r(e){return"[object Array]"===t.call(e)}function i(e){return"[object String]"===t.call(e)}function o(e,t){return n.call(e,t)}function s(e,t){var n;return t=u(t),p(e,(function(e,r){if(t(e,r))return n=e,!1})),n}function a(e,t){var n=[];return p(e,(function(e,r){t(e,r)&&n.push(e)})),n}function p(e,t){var n;if(void 0!==e){var i=r(e)?f:c;for(var s in e)if(o(e,s)&&!1===t(n=e[s],i(s)))return n}}function u(e){return n=e,"[object Function]"===(r=t.call(n))||"[object AsyncFunction]"===r||"[object GeneratorFunction]"===r||"[object AsyncGeneratorFunction]"===r||"[object Proxy]"===r?e:function(t){return t===e};var n,r}function c(e){return e}function f(e){return Number(e)}function l(e,t){return e.bind(t)}function d(){return(d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function h(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return d.apply(void 0,[e].concat(n))}var m=String.fromCharCode,y=Object.prototype.hasOwnProperty,g=/&#(\d+);|&#x([0-9a-f]+);|&(\w+);/gi,v={amp:"&",apos:"'",gt:">",lt:"<",quot:'"'};function b(e,t,n,r){return r?y.call(v,r)?v[r]:"&"+r+";":m(t||parseInt(n,16))}function x(e){return e.length>3&&-1!==e.indexOf("&")?e.replace(g,b):e}Object.keys(v).forEach((function(e){v[e.toUpperCase()]=v[e]}));var N="xsi:type",w="non-whitespace outside of root node";function P(e){return new Error(e)}function T(e){return"missing namespace for prefix <"+e+">"}function O(e){return{get:e,enumerable:!0}}function A(e){var t,n={};for(t in e)n[t]=e[t];return n}function k(e){return e+"$uri"}function E(){return{line:0,column:0}}function $(e){throw e}function j(e){if(!this)return new j(e);var t,n,r,i,o,s,a,p,u,c=e&&e.proxy,f=$,l=E,d=!1,h=!1,m=null,y=!1;function g(e){e instanceof Error||(e=P(e)),m=e,f(e,l)}function v(e){o&&(e instanceof Error||(e=P(e)),o(e,l))}this.on=function(e,u){if("function"!=typeof u)throw P("required args <name, cb>");switch(e){case"openTag":n=u;break;case"text":t=u;break;case"closeTag":r=u;break;case"error":f=u;break;case"warn":o=u;break;case"cdata":i=u;break;case"attention":p=u;break;case"question":a=u;break;case"comment":s=u;break;default:throw P("unsupported event: "+e)}return this},this.ns=function(e){if(void 0===e&&(e={}),"object"!=typeof e)throw P("required args <nsMap={}>");var t,n={};for(t in e)n[t]=e[t];return n["http://www.w3.org/2001/XMLSchema-instance"]="xsi",h=!0,u=n,this},this.parse=function(e){if("string"!=typeof e)throw P("required args <xml=string>");return m=null,function(e){var o,f,m,b,P,E,$,j,B,C,M,D=h?[]:null,U=h?function(e){var t,n,r={};for(t in e)r[n=e[t]]=n,r[k(n)]=t;return r}(u):null,I=[],R=0,L=!1,z=!1,S=0,q=0,F="",G=0;function X(){if(null!==M)return M;var e,t,n,r,i,o,s,a,p,c,f,l=h&&U.xmlns,m=h&&d?[]:null,y=G,g=F,b=g.length,w={},P={};e:for(;y<b;y++)if(p=!1,!(32===(c=g.charCodeAt(y))||c<14&&c>8)){for((c<65||c>122||c>90&&c<97)&&95!==c&&58!==c&&(v("illegal first char attribute name"),p=!0),f=y+1;f<b;f++)if(!((c=g.charCodeAt(f))>96&&c<123||c>64&&c<91||c>47&&c<59||46===c||45===c||95===c)){if(32===c||c<14&&c>8){v("missing attribute value"),y=f;continue e}if(61===c)break;v("illegal attribute name char"),p=!0}if("xmlns:xmlns"===(a=g.substring(y,f))&&(v("illegal declaration of xmlns"),p=!0),34===(c=g.charCodeAt(f+1)))-1===(f=g.indexOf('"',y=f+2))&&-1!==(f=g.indexOf("'",y))&&(v("attribute value quote missmatch"),p=!0);else if(39===c)-1===(f=g.indexOf("'",y=f+2))&&-1!==(f=g.indexOf('"',y))&&(v("attribute value quote missmatch"),p=!0);else for(v("missing attribute value quotes"),p=!0,f+=1;f<b&&!(32===(c=g.charCodeAt(f+1))||c<14&&c>8);f++);for(-1===f&&(v("missing closing quotes"),f=b,p=!0),p||(o=g.substring(y,f)),y=f;f+1<b&&!(32===(c=g.charCodeAt(f+1))||c<14&&c>8);f++)y===f&&(v("illegal character after attribute end"),p=!0);if(y=f+1,!p)if(a in P)v("attribute <"+a+"> already defined");else if(P[a]=!0,h)if(d){if(null!==(i="xmlns"===a?"xmlns":120===a.charCodeAt(0)&&"xmlns:"===a.substr(0,6)?a.substr(6):null)){if(e=x(o),t=k(i),!(s=u[e])){if("xmlns"===i||t in U&&U[t]!==e)do{s="ns"+R++}while(void 0!==U[s]);else s=i;u[e]=s}U[i]!==s&&(r||(U=A(U),r=!0),U[i]=s,"xmlns"===i&&(U[k(s)]=e,l=s),U[t]=e),w[a]=o;continue}m.push(a,o)}else-1!==(c=a.indexOf(":"))?(n=U[a.substring(0,c)])?((a=l===n?a.substr(c+1):n+a.substr(c))===N&&(-1!==(c=o.indexOf(":"))?(n=o.substring(0,c),o=(n=U[n]||n)+o.substring(c)):o=l+":"+o),w[a]=o):v(T(a.substring(0,c))):w[a]=o;else w[a]=o}if(d)for(y=0,b=m.length;y<b;y++){if(a=m[y++],o=m[y],-1!==(c=a.indexOf(":"))){if(!(n=U[a.substring(0,c)])){v(T(a.substring(0,c)));continue}(a=l===n?a.substr(c+1):n+a.substr(c))===N&&(-1!==(c=o.indexOf(":"))?(n=o.substring(0,c),o=(n=U[n]||n)+o.substring(c)):o=l+":"+o)}w[a]=o}return M=w}function H(){for(var t,n,r=/(\r\n|\r|\n)/g,i=0,o=0,s=0,a=q;S>=s&&(t=r.exec(e))&&!((a=t[0].length+t.index)>S);)i+=1,s=a;return-1==S?(o=a,n=e.substring(q)):0===q?n=e.substring(q,S):(o=S-s,n=-1==q?e.substring(S):e.substring(S,q+1)),{data:n,line:i,column:o}}l=H,c&&(C=Object.create({},{name:O((function(){return j})),originalName:O((function(){return B})),attrs:O(X),ns:O((function(){return U}))}));for(;-1!==q;){if(-1===(S=60===e.charCodeAt(q)?q:e.indexOf("<",q)))return I.length?g("unexpected end of file"):0===q?g("missing start tag"):void(q<e.length&&e.substring(q).trim()&&v(w));if(q!==S)if(I.length){if(t&&(t(e.substring(q,S),x,l),y))return}else if(e.substring(q,S).trim()&&(v(w),y))return;if(33===(P=e.charCodeAt(S+1))){if(91===(b=e.charCodeAt(S+2))&&"CDATA["===e.substr(S+3,6)){if(-1===(q=e.indexOf("]]>",S)))return g("unclosed cdata");if(i&&(i(e.substring(S+9,q),l),y))return;q+=3;continue}if(45===b&&45===e.charCodeAt(S+3)){if(-1===(q=e.indexOf("--\x3e",S)))return g("unclosed comment");if(s&&(s(e.substring(S+4,q),x,l),y))return;q+=3;continue}}if(63!==P){for(f=S+1;;f++){if(E=e.charCodeAt(f),isNaN(E))return q=-1,g("unclosed tag");if(34===E)f=-1!==(b=e.indexOf('"',f+1))?b:f;else if(39===E)f=-1!==(b=e.indexOf("'",f+1))?b:f;else if(62===E){q=f;break}}if(33!==P){if(M={},47===P){if(L=!1,z=!0,!I.length)return g("missing open tag");if(f=j=I.pop(),b=S+2+f.length,e.substring(S+2,b)!==f)return g("closing tag mismatch");for(;b<q;b++)if(!(32===(P=e.charCodeAt(b))||P>8&&P<14))return g("close tag")}else{if(47===e.charCodeAt(q-1)?(f=j=e.substring(S+1,q-1),L=!0,z=!0):(f=j=e.substring(S+1,q),L=!0,z=!1),!(P>96&&P<123||P>64&&P<91||95===P||58===P))return g("illegal first char nodeName");for(b=1,m=f.length;b<m;b++)if(!((P=f.charCodeAt(b))>96&&P<123||P>64&&P<91||P>47&&P<59||45===P||95===P||46==P)){if(32===P||P<14&&P>8){j=f.substring(0,b),M=null;break}return g("invalid nodeName")}z||I.push(j)}if(h){if(o=U,L&&(z||D.push(o),null===M&&(d=-1!==f.indexOf("xmlns",b))&&(G=b,F=f,X(),d=!1)),B=j,-1!==(P=j.indexOf(":"))){if(!($=U[j.substring(0,P)]))return g("missing namespace on <"+B+">");j=j.substr(P+1)}else $=U.xmlns;$&&(j=$+":"+j)}if(L&&(G=b,F=f,n&&(c?n(C,x,z,l):n(j,X,x,z,l),y)))return;if(z){if(r&&(r(c?C:j,x,L,l),y))return;h&&(U=L?o:D.pop())}q+=1}else{if(p&&(p(e.substring(S,q+1),x,l),y))return;q+=1}}else{if(-1===(q=e.indexOf("?>",S)))return g("unclosed question");if(a&&(a(e.substring(S,q+2),l),y))return;q+=2}}}(e),l=E,y=!1,m},this.stop=function(){y=!0}}function B(){}function C(e,t){this.model=e,this.properties=t}B.prototype.get=function(e){return this.$model.properties.get(this,e)},B.prototype.set=function(e,t){this.$model.properties.set(this,e,t)},C.prototype.createType=function(e){var t=this.model,n=this.properties,r=Object.create(B.prototype);p(e.properties,(function(e){e.isMany||void 0===e.default||(r[e.name]=e.default)})),n.defineModel(r,t),n.defineDescriptor(r,e);var i=e.ns.name;function o(e){n.define(this,"$type",{value:i,enumerable:!0}),n.define(this,"$attrs",{value:{}}),n.define(this,"$parent",{writable:!0}),p(e,l((function(e,t){this.set(t,e)}),this))}return o.prototype=r,o.hasType=r.$instanceOf=this.model.hasType,n.defineModel(o,t),n.defineDescriptor(o,e),o};var M={String:!0,Boolean:!0,Integer:!0,Real:!0,Element:!0},D={String:function(e){return e},Boolean:function(e){return"true"===e},Integer:function(e){return parseInt(e,10)},Real:function(e){return parseFloat(e)}};function U(e,t){var n=D[e];return n?n(t):t}function I(e){return!!M[e]}function R(e){return!!D[e]}function L(e,t){var n,r,i=e.split(/:/);if(1===i.length)n=e,r=t;else{if(2!==i.length)throw new Error("expected <prefix:localName> or <localName>, got "+e);n=i[1],r=i[0]}return{name:e=(r?r+":":"")+n,prefix:r,localName:n}}function z(e){this.ns=e,this.name=e.name,this.allTypes=[],this.allTypesByName={},this.properties=[],this.propertiesByName={}}function S(e,t){this.packageMap={},this.typeMap={},this.packages=[],this.properties=t,p(e,l(this.registerPackage,this))}function q(e,t,n){var r=t[n];if(r in e)throw new Error("package with "+n+" <"+r+"> already defined")}function F(e){this.model=e}function G(e,t,n){Object.defineProperty(e,t.name,{enumerable:!t.isReference,writable:!0,value:n,configurable:!0})}function X(e){this.properties=new F(this),this.factory=new C(this,this.properties),this.registry=new S(e,this.properties),this.typeCache={}}function H(e){return e.xml&&"lowerCase"===e.xml.tagAlias}z.prototype.build=function(){return e=this,t=["ns","name","allTypes","allTypesByName","properties","propertiesByName","bodyProperty","idProperty"],n={},r=Object(e),p(t,(function(t){t in r&&(n[t]=e[t])})),n;var e,t,n,r},z.prototype.addProperty=function(e,t,n){"boolean"==typeof t&&(n=t,t=void 0),this.addNamedProperty(e,!1!==n);var r=this.properties;void 0!==t?r.splice(t,0,e):r.push(e)},z.prototype.replaceProperty=function(e,t,n){var r=e.ns,i=this.properties,o=this.propertiesByName,s=e.name!==t.name;if(e.isId){if(!t.isId)throw new Error("property <"+t.ns.name+"> must be id property to refine <"+e.ns.name+">");this.setIdProperty(t,!1)}if(e.isBody){if(!t.isBody)throw new Error("property <"+t.ns.name+"> must be body property to refine <"+e.ns.name+">");this.setBodyProperty(t,!1)}var a=i.indexOf(e);if(-1===a)throw new Error("property <"+r.name+"> not found in property list");i.splice(a,1),this.addProperty(t,n?void 0:a,s),o[r.name]=o[r.localName]=t},z.prototype.redefineProperty=function(e,t,n){var r=e.ns.prefix,i=t.split("#"),o=L(i[0],r),s=L(i[1],o.prefix).name,a=this.propertiesByName[s];if(!a)throw new Error("refined property <"+s+"> not found");this.replaceProperty(a,e,n),delete e.redefines},z.prototype.addNamedProperty=function(e,t){var n=e.ns,r=this.propertiesByName;t&&(this.assertNotDefined(e,n.name),this.assertNotDefined(e,n.localName)),r[n.name]=r[n.localName]=e},z.prototype.removeNamedProperty=function(e){var t=e.ns,n=this.propertiesByName;delete n[t.name],delete n[t.localName]},z.prototype.setBodyProperty=function(e,t){if(t&&this.bodyProperty)throw new Error("body property defined multiple times (<"+this.bodyProperty.ns.name+">, <"+e.ns.name+">)");this.bodyProperty=e},z.prototype.setIdProperty=function(e,t){if(t&&this.idProperty)throw new Error("id property defined multiple times (<"+this.idProperty.ns.name+">, <"+e.ns.name+">)");this.idProperty=e},z.prototype.assertNotDefined=function(e,t){var n=e.name,r=this.propertiesByName[n];if(r)throw new Error("property <"+n+"> already defined; override of <"+r.definedBy.ns.name+"#"+r.ns.name+"> by <"+e.definedBy.ns.name+"#"+e.ns.name+"> not allowed without redefines")},z.prototype.hasProperty=function(e){return this.propertiesByName[e]},z.prototype.addTrait=function(e,t){var n=this.allTypesByName,r=this.allTypes,i=e.name;i in n||(p(e.properties,l((function(n){n=h({},n,{name:n.ns.localName,inherited:t}),Object.defineProperty(n,"definedBy",{value:e});var r=n.replaces,i=n.redefines;r||i?this.redefineProperty(n,r||i,r):(n.isBody&&this.setBodyProperty(n),n.isId&&this.setIdProperty(n),this.addProperty(n))}),this)),r.push(e),n[i]=e)},S.prototype.getPackage=function(e){return this.packageMap[e]},S.prototype.getPackages=function(){return this.packages},S.prototype.registerPackage=function(e){e=h({},e);var t=this.packageMap;q(t,e,"prefix"),q(t,e,"uri"),p(e.types,l((function(t){this.registerType(t,e)}),this)),t[e.uri]=t[e.prefix]=e,this.packages.push(e)},S.prototype.registerType=function(e,t){var n=L((e=h({},e,{superClass:(e.superClass||[]).slice(),extends:(e.extends||[]).slice(),properties:(e.properties||[]).slice(),meta:h(e.meta||{})})).name,t.prefix),r=n.name,i={};p(e.properties,l((function(e){var t=L(e.name,n.prefix),r=t.name;I(e.type)||(e.type=L(e.type,t.prefix).name),h(e,{ns:t,name:r}),i[r]=e}),this)),h(e,{ns:n,name:r,propertiesByName:i}),p(e.extends,l((function(e){var t=this.typeMap[e];t.traits=t.traits||[],t.traits.push(r)}),this)),this.definePackage(e,t),this.typeMap[r]=e},S.prototype.mapTypes=function(e,t,n){var r=I(e.name)?{name:e.name}:this.typeMap[e.name],i=this;function o(e){return s(e,!0)}function s(n,r){var o=L(n,I(n)?"":e.prefix);i.mapTypes(o,t,r)}if(!r)throw new Error("unknown type <"+e.name+">");p(r.superClass,n?o:s),t(r,!n),p(r.traits,o)},S.prototype.getEffectiveDescriptor=function(e){var t=L(e),n=new z(t);this.mapTypes(t,(function(e,t){n.addTrait(e,t)}));var r=n.build();return this.definePackage(r,r.allTypes[r.allTypes.length-1].$pkg),r},S.prototype.definePackage=function(e,t){this.properties.define(e,"$pkg",{value:t})},F.prototype.set=function(e,t,n){var r=this.model.getPropertyDescriptor(e,t),i=r&&r.name;void 0===n?r?delete e[i]:delete e.$attrs[t]:r?i in e?e[i]=n:G(e,r,n):e.$attrs[t]=n},F.prototype.get=function(e,t){var n=this.model.getPropertyDescriptor(e,t);if(!n)return e.$attrs[t];var r=n.name;return!e[r]&&n.isMany&&G(e,n,[]),e[r]},F.prototype.define=function(e,t,n){Object.defineProperty(e,t,n)},F.prototype.defineDescriptor=function(e,t){this.define(e,"$descriptor",{value:t})},F.prototype.defineModel=function(e,t){this.define(e,"$model",{value:t})},X.prototype.create=function(e,t){var n=this.getType(e);if(!n)throw new Error("unknown type <"+e+">");return new n(t)},X.prototype.getType=function(e){var t=this.typeCache,n=i(e)?e:e.ns.name,r=t[n];return r||(e=this.registry.getEffectiveDescriptor(n),r=t[n]=this.factory.createType(e)),r},X.prototype.createAny=function(e,n,r){var i=L(e),o={$type:e,$instanceOf:function(e){return e===this.$type}},s={name:e,isGeneric:!0,ns:{prefix:i.prefix,localName:i.localName,uri:n}};return this.properties.defineDescriptor(o,s),this.properties.defineModel(o,this),this.properties.define(o,"$parent",{enumerable:!1,writable:!0}),this.properties.define(o,"$instanceOf",{enumerable:!1,writable:!0}),p(r,(function(e,n){var r;r=e,"[object Object]"===t.call(r)&&void 0!==e.value?o[e.name]=e.value:o[n]=e})),o},X.prototype.getPackage=function(e){return this.registry.getPackage(e)},X.prototype.getPackages=function(){return this.registry.getPackages()},X.prototype.getElementDescriptor=function(e){return e.$descriptor},X.prototype.hasType=function(e,t){return void 0===t&&(t=e,e=this),t in e.$model.getElementDescriptor(e).allTypesByName},X.prototype.getPropertyDescriptor=function(e,t){return this.getElementDescriptor(e).propertiesByName[t]},X.prototype.getTypeDescriptor=function(e){return this.registry.typeMap[e]};var W={xsi:"http://www.w3.org/2001/XMLSchema-instance",xml:"http://www.w3.org/XML/1998/namespace"},_="xsi:type";function V(e){return e.xml&&e.xml.serialize}function K(e){return V(e)===_}function J(e,t){return H(t)?e.prefix+":"+((n=e.localName).charAt(0).toUpperCase()+n.slice(1)):e.name;var n}function Q(e){return new Error(e)}function Y(e){return e.$descriptor}function Z(e){h(this,e),this.elementsById={},this.references=[],this.warnings=[],this.addReference=function(e){this.references.push(e)},this.addElement=function(e){if(!e)throw Q("expected element");var t,n=this.elementsById,r=Y(e).idProperty;if(r&&(t=e.get(r.name))){if(!/^([a-z][\w-.]*:)?[a-z_][\w-.]*$/i.test(t))throw new Error("illegal ID <"+t+">");if(n[t])throw Q("duplicate ID <"+t+">");n[t]=e}},this.addWarning=function(e){this.warnings.push(e)}}function ee(){}function te(){}function ne(){}function re(e,t){this.property=e,this.context=t}function ie(e,t){this.element=t,this.propertyDesc=e}function oe(){}function se(e,t,n){this.model=e,this.type=e.getType(t),this.context=n}function ae(e,t,n){se.call(this,e,t,n)}function pe(e,t,n){this.model=e,this.context=n}function ue(e){e instanceof X&&(e={model:e}),h(this,{lax:!1},e)}ee.prototype.handleEnd=function(){},ee.prototype.handleText=function(){},ee.prototype.handleNode=function(){},te.prototype=Object.create(ee.prototype),te.prototype.handleNode=function(){return this},ne.prototype=Object.create(ee.prototype),ne.prototype.handleText=function(e){this.body=(this.body||"")+e},re.prototype=Object.create(ne.prototype),re.prototype.handleNode=function(e){if(this.element)throw Q("expected no sub nodes");return this.element=this.createReference(e),this},re.prototype.handleEnd=function(){this.element.id=this.body},re.prototype.createReference=function(e){return{property:this.property.ns.name,id:""}},ie.prototype=Object.create(ne.prototype),ie.prototype.handleEnd=function(){var e=this.body||"",t=this.element,n=this.propertyDesc;e=U(n.type,e),n.isMany?t.get(n.name).push(e):t.set(n.name,e)},oe.prototype=Object.create(ne.prototype),oe.prototype.handleNode=function(e){var t=this,n=this.element;return n?t=this.handleChild(e):(n=this.element=this.createElement(e),this.context.addElement(n)),t},se.prototype=Object.create(oe.prototype),se.prototype.addReference=function(e){this.context.addReference(e)},se.prototype.handleText=function(e){if(!Y(this.element).bodyProperty)throw Q("unexpected body text <"+e+">");ne.prototype.handleText.call(this,e)},se.prototype.handleEnd=function(){var e=this.body,t=this.element,n=Y(t).bodyProperty;n&&void 0!==e&&(e=U(n.type,e),t.set(n.name,e))},se.prototype.createElement=function(e){var t,n=e.attributes,r=this.type,i=Y(r),o=this.context,s=new r({}),a=this.model;return p(n,(function(e,n){var r=i.propertiesByName[n];r&&r.isReference?r.isMany?p(e.split(" "),(function(e){o.addReference({element:s,property:r.ns.name,id:e})})):o.addReference({element:s,property:r.ns.name,id:e}):(r?e=U(r.type,e):"xmlns"!==n&&(t=L(n,i.ns.prefix),a.getPackage(t.prefix)&&o.addWarning({message:"unknown attribute <"+n+">",element:s,property:n,value:e})),s.set(n,e))})),s},se.prototype.getPropertyForNode=function(e){var t,n,r=L(e.name),i=this.type,o=this.model,a=Y(i),p=r.name,u=a.propertiesByName[p];if(u&&!u.isAttr)return K(u)&&(t=e.attributes[_])?(t=function(e,t){var n=L(e);return function(e,t){var n=e.name,r=e.localName,i=t.xml&&t.xml.typePrefix;return i&&0===r.indexOf(i)?e.prefix+":"+r.slice(i.length):n}(n,t.getPackage(n.prefix))}(t,o),h({},u,{effectiveType:Y(n=o.getType(t)).name})):u;var c=o.getPackage(r.prefix);if(c){if(t=J(r,c),n=o.getType(t),u=s(a.properties,(function(e){return!e.isVirtual&&!e.isReference&&!e.isAttribute&&n.hasType(e.type)})))return h({},u,{effectiveType:Y(n).name})}else if(u=s(a.properties,(function(e){return!e.isReference&&!e.isAttribute&&"Element"===e.type})))return u;throw Q("unrecognized element <"+r.name+">")},se.prototype.toString=function(){return"ElementDescriptor["+Y(this.type).name+"]"},se.prototype.valueHandler=function(e,t){return new ie(e,t)},se.prototype.referenceHandler=function(e){return new re(e,this.context)},se.prototype.handler=function(e){return"Element"===e?new pe(this.model,e,this.context):new se(this.model,e,this.context)},se.prototype.handleChild=function(e){var t,n,r,i;if(t=this.getPropertyForNode(e),r=this.element,R(n=t.effectiveType||t.type))return this.valueHandler(t,r);var o=(i=t.isReference?this.referenceHandler(t).handleNode(e):this.handler(n).handleNode(e)).element;return void 0!==o&&(t.isMany?r.get(t.name).push(o):r.set(t.name,o),t.isReference?(h(o,{element:r}),this.context.addReference(o)):o.$parent=r),i},ae.prototype=Object.create(se.prototype),ae.prototype.createElement=function(e){var t=e.name,n=L(t),r=this.model,i=this.type,o=r.getPackage(n.prefix),s=o&&J(n,o)||t;if(!i.hasType(s))throw Q("unexpected element <"+e.originalName+">");return se.prototype.createElement.call(this,e)},pe.prototype=Object.create(oe.prototype),pe.prototype.createElement=function(e){var t=e.name,n=L(t).prefix,r=e.ns[n+"$uri"],i=e.attributes;return this.model.createAny(t,r,i)},pe.prototype.handleChild=function(e){var t=new pe(this.model,"Element",this.context).handleNode(e),n=this.element,r=t.element;return void 0!==r&&((n.$children=n.$children||[]).push(r),r.$parent=n),t},pe.prototype.handleEnd=function(){this.body&&(this.element.$body=this.body)},ue.prototype.fromXML=function(e,t,n){var r=t.rootHandler;t instanceof se?(r=t,t={}):"string"==typeof t?(r=this.handler(t),t={}):"string"==typeof r&&(r=this.handler(r));var i=this.model,o=this.lax,s=new Z(h({},t,{rootHandler:r})),a=new j({proxy:!0}),p=function(){var e=[];return Object.defineProperty(e,"peek",{value:function(){return this[this.length-1]}}),e}();function u(e,t,n){var r=t(),i=r.line,o=r.column,a=r.data;"<"===a.charAt(0)&&-1!==a.indexOf(" ")&&(a=a.slice(0,a.indexOf(" "))+">");var p="unparsable content "+(a?a+" ":"")+"detected\n\tline: "+i+"\n\tcolumn: "+o+"\n\tnested error: "+e.message;if(n)return s.addWarning({message:p,error:e}),!0;throw Q(p)}function c(e,t){return u(e,t,!0)}r.context=s,p.push(r);var f=/^<\?xml /i,l=/ encoding="([^"]+)"/i,d=/^utf-8$/i;function m(e,t){try{p.peek().handleText(e)}catch(e){c(e,t)}}var y=i.getPackages().reduce((function(e,t){return e[t.uri]=t.prefix,e}),{"http://www.w3.org/XML/1998/namespace":"xml"});return a.ns(y).on("openTag",(function(e,t,n,r){var i=e.attrs||{},s=Object.keys(i).reduce((function(e,n){var r=t(i[n]);return e[n]=r,e}),{});!function(e,t){var n=p.peek();try{p.push(n.handleNode(e))}catch(e){u(e,t,o)&&p.push(new te)}}({name:e.name,originalName:e.originalName,attributes:s,ns:e.ns},r)})).on("question",(function(e){if(f.test(e)){var t=l.exec(e),n=t&&t[1];n&&!d.test(n)&&s.addWarning({message:"unsupported document encoding <"+n+">, falling back to UTF-8"})}})).on("closeTag",(function(){p.pop().handleEnd()})).on("cdata",m).on("text",(function(e,t,n){!function(e,t){e.trim()&&m(e,t)}(t(e),n)})).on("error",u).on("warn",c),new Promise((function(t,n){var i;try{a.parse(e),function(){var e,t,n=s.elementsById,r=s.references;for(e=0;t=r[e];e++){var i=t.element,o=n[t.id],a=Y(i).propertiesByName[t.property];if(o||s.addWarning({message:"unresolved reference <"+t.id+">",element:t.element,property:t.property,value:t.id}),a.isMany){var p=i.get(a.name),u=p.indexOf(t);-1===u&&(u=p.length),o?p[u]=o:p.splice(u,1)}else i.set(a.name,o)}}()}catch(e){i=e}var o=r.element;i||o||(i=Q("failed to parse document as <"+r.type.$descriptor.name+">"));var p=s.warnings,u=s.references,c=s.elementsById;return i?(i.warnings=p,n(i)):t({rootElement:o,elementsById:c,references:u,warnings:p})}))},ue.prototype.handler=function(e){return new ae(this.model,e)};var ce=/<|>|'|"|&|\n\r|\n/g,fe=/<|>|&/g;function le(e){var t={},n={},r={},i=[],o=[];this.byUri=function(t){return n[t]||e&&e.byUri(t)},this.add=function(e,t){n[e.uri]=e,t?i.push(e):o.push(e),this.mapPrefix(e.prefix,e.uri)},this.uriByPrefix=function(e){return t[e||"xmlns"]},this.mapPrefix=function(e,n){t[e||"xmlns"]=n},this.getNSKey=function(e){return void 0!==e.prefix?e.uri+"|"+e.prefix:e.uri},this.logUsed=function(t){var n=t.uri,i=this.getNSKey(t);r[i]=this.byUri(n),e&&e.logUsed(t)},this.getUsed=function(e){var t=this;return[].concat(i,o).filter((function(e){var n=t.getNSKey(e);return r[n]}))}}function de(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}function he(e){return i(e)?e:(e.prefix?e.prefix+":":"")+e.localName}var me={"\n":"#10","\n\r":"#10",'"':"#34","'":"#39","<":"#60",">":"#62","&":"#38"},ye={"<":"lt",">":"gt","&":"amp"};function ge(e,t,n){return(e=i(e)?e:""+e).replace(t,(function(e){return"&"+n[e]+";"}))}function ve(e){this.tagName=e}function be(){}function xe(e){this.tagName=e}function Ne(e,t){this.body=[],this.attrs=[],this.parent=e,this.propertyDescriptor=t}function we(e,t){Ne.call(this,e,t)}function Pe(){this.value="",this.write=function(e){this.value+=e}}function Te(e,t){var n=[""];this.append=function(t){return e.write(t),this},this.appendNewLine=function(){return t&&e.write("\n"),this},this.appendIndent=function(){return t&&e.write(n.join("  ")),this},this.indent=function(){return n.push(""),this},this.unindent=function(){return n.pop(),this}}ve.prototype.build=function(e){return this.element=e,this},ve.prototype.serializeTo=function(e){e.appendIndent().append("<"+this.tagName+">"+this.element.id+"</"+this.tagName+">").appendNewLine()},be.prototype.serializeValue=be.prototype.serializeTo=function(e){e.append(this.escape?ge(this.value,fe,ye):this.value)},be.prototype.build=function(e,t){return this.value=t,"String"===e.type&&-1!==t.search(fe)&&(this.escape=!0),this},de(xe,be),xe.prototype.serializeTo=function(e){e.appendIndent().append("<"+this.tagName+">"),this.serializeValue(e),e.append("</"+this.tagName+">").appendNewLine()},Ne.prototype.build=function(e){this.element=e;var t,n,r=e.$descriptor,i=this.propertyDescriptor,s=r.isGeneric;return t=s?this.parseGeneric(e):this.parseNsAttributes(e),this.ns=i?this.nsPropertyTagName(i):this.nsTagName(r),this.tagName=this.addTagName(this.ns),s||(n=function(e){return a(e.$descriptor.properties,(function(t){var n=t.name;if(t.isVirtual)return!1;if(!o(e,n))return!1;var r=e[n];return r!==t.default&&null!==r&&(!t.isMany||r.length)}))}(e),this.parseAttributes(a(n,(function(e){return e.isAttr}))),this.parseContainments(function(e){return a(e,(function(e){return!e.isAttr}))}(n))),this.parseGenericAttributes(e,t),this},Ne.prototype.nsTagName=function(e){return function(e,t){return t.isGeneric?h({localName:t.ns.localName},e):h({localName:(n=t.ns.localName,r=t.$pkg,H(r)?(i=n).charAt(0).toLowerCase()+i.slice(1):n)},e);var n,r,i}(this.logNamespaceUsed(e.ns),e)},Ne.prototype.nsPropertyTagName=function(e){return function(e,t){return h({localName:t.ns.localName},e)}(this.logNamespaceUsed(e.ns),e)},Ne.prototype.isLocalNs=function(e){return e.uri===this.ns.uri},Ne.prototype.nsAttributeName=function(e){var t;if(t=i(e)?L(e):e.ns,e.inherited)return{localName:t.localName};var n=this.logNamespaceUsed(t);return this.getNamespaces().logUsed(n),this.isLocalNs(n)?{localName:t.localName}:h({localName:t.localName},n)},Ne.prototype.parseGeneric=function(e){var t=this,n=this.body,r=[];return p(e,(function(i,o){"$body"===o?n.push((new be).build({type:"String"},i)):"$children"===o?p(i,(function(e){n.push(new Ne(t).build(e))})):0!==o.indexOf("$")&&t.parseNsAttribute(e,o,i)&&r.push({name:o,value:i})})),r},Ne.prototype.parseNsAttribute=function(e,t,n){var r,i=e.$model,o=L(t);if("xmlns"===o.prefix&&(r={prefix:o.localName,uri:n}),o.prefix||"xmlns"!==o.localName||(r={uri:n}),!r)return{name:t,value:n};if(i&&i.getPackage(n))this.logNamespace(r,!0,!0);else{var s=this.logNamespaceUsed(r,!0);this.getNamespaces().logUsed(s)}},Ne.prototype.parseNsAttributes=function(e,t){var n=this,r=e.$attrs,i=[];return p(r,(function(t,r){var o=n.parseNsAttribute(e,r,t);o&&i.push(o)})),i},Ne.prototype.parseGenericAttributes=function(e,t){var n=this;p(t,(function(t){if(t.name!==_)try{n.addAttribute(n.nsAttributeName(t.name),t.value)}catch(n){console.warn("missing namespace information for ",t.name,"=",t.value,"on",e,n)}}))},Ne.prototype.parseContainments=function(e){var t=this,n=this.body,r=this.element;p(e,(function(e){var i=r.get(e.name),o=e.isReference;if(e.isMany||(i=[i]),e.isBody)n.push((new be).build(e,i[0]));else if(R(e.type))p(i,(function(r){n.push(new xe(t.addTagName(t.nsPropertyTagName(e))).build(e,r))}));else if(o)p(i,(function(r){n.push(new ve(t.addTagName(t.nsPropertyTagName(e))).build(r))}));else{var s=K(e),a=function(e){return"property"===V(e)}(e);p(i,(function(r){var i;i=s?new we(t,e):a?new Ne(t,e):new Ne(t),n.push(i.build(r))}))}}))},Ne.prototype.getNamespaces=function(e){var t,n=this.namespaces,r=this.parent;return n||(t=r&&r.getNamespaces(),e||!t?this.namespaces=n=new le(t):n=t),n},Ne.prototype.logNamespace=function(e,t,n){var r=this.getNamespaces(n),i=e.uri,o=e.prefix;return r.byUri(i)&&!n||r.add(e,t),r.mapPrefix(o,i),e},Ne.prototype.logNamespaceUsed=function(e,t){var n,r,i,o=this.element.$model,s=this.getNamespaces(t),a=e.prefix,p=e.uri;if(!a&&!p)return{localName:e.localName};if(i=W[a]||o&&(o.getPackage(a)||{}).uri,!(p=p||i||s.uriByPrefix(a)))throw new Error("no namespace uri given for prefix <"+a+">");if(!(e=s.byUri(p))){for(n=a,r=1;s.uriByPrefix(n);)n=a+"_"+r++;e=this.logNamespace({prefix:n,uri:p},i===p)}return a&&s.mapPrefix(a,p),e},Ne.prototype.parseAttributes=function(e){var t=this,n=this.element;p(e,(function(e){var r=n.get(e.name);if(e.isReference)if(e.isMany){var i=[];p(r,(function(e){i.push(e.id)})),r=i.join(" ")}else r=r.id;t.addAttribute(t.nsAttributeName(e),r)}))},Ne.prototype.addTagName=function(e){var t=this.logNamespaceUsed(e);return this.getNamespaces().logUsed(t),he(e)},Ne.prototype.addAttribute=function(e,t){var n=this.attrs;i(t)&&(t=ge(t,ce,me));var o=function(e,t){t=u(t);var n=r(e)?-1:void 0;return p(e,(function(e,r){if(t(e,r))return n=r,!1})),n}(n,(function(t){return t.name.localName===e.localName&&t.name.uri===e.uri&&t.name.prefix===e.prefix})),s={name:e,value:t};-1!==o?n.splice(o,1,s):n.push(s)},Ne.prototype.serializeAttributes=function(e){var t=this.attrs,n=this.namespaces;n&&(t=function(e){return e.getUsed().filter((function(e){return"xml"!==e.prefix})).map((function(e){return{name:"xmlns"+(e.prefix?":"+e.prefix:""),value:e.uri}}))}(n).concat(t)),p(t,(function(t){e.append(" ").append(he(t.name)).append('="').append(t.value).append('"')}))},Ne.prototype.serializeTo=function(e){var t=this.body[0],n=t&&t.constructor!==be;e.appendIndent().append("<"+this.tagName),this.serializeAttributes(e),e.append(t?">":" />"),t&&(n&&e.appendNewLine().indent(),p(this.body,(function(t){t.serializeTo(e)})),n&&e.unindent().appendIndent(),e.append("</"+this.tagName+">")),e.appendNewLine()},de(we,Ne),we.prototype.parseNsAttributes=function(e){var t=Ne.prototype.parseNsAttributes.call(this,e),n=e.$descriptor;if(n.name===this.propertyDescriptor.type)return t;var r=this.typeNs=this.nsTagName(n);this.getNamespaces().logUsed(this.typeNs);var i=e.$model.getPackage(r.uri),o=i.xml&&i.xml.typePrefix||"";return this.addAttribute(this.nsAttributeName(_),(r.prefix?r.prefix+":":"")+o+n.ns.localName),t},we.prototype.isLocalNs=function(e){return e.uri===(this.typeNs||this.ns).uri},e.Reader=ue,e.Writer=function(e){return e=h({format:!1,preamble:!0},e||{}),{toXML:function(t,n){var r=n||new Pe,i=new Te(r,e.format);if(e.preamble&&i.append('<?xml version="1.0" encoding="UTF-8"?>\n'),(new Ne).build(t).serializeTo(i),!n)return r.value}}},Object.defineProperty(e,"__esModule",{value:!0})}));
