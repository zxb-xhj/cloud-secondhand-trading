!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).Moddle={})}(this,function(e){"use strict";var t=Object.prototype.toString,r=Object.prototype.hasOwnProperty;function n(e){return"[object String]"===t.call(e)}function i(e,t){return r.call(e,t)}function o(e,r){if(void 0!==e){var n=function(e){return"[object Array]"===t.call(e)}(e)?s:p;for(var o in e){if(i(e,o))if(!1===r(e[o],n(o)))return}}}function p(e){return e}function s(e){return Number(e)}function a(e,t){return e.bind(t)}var f=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e};function y(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return f.apply(void 0,[e].concat(r))}function c(){}function u(e,t){this.model=e,this.properties=t}c.prototype.get=function(e){return this.$model.properties.get(this,e)},c.prototype.set=function(e,t){this.$model.properties.set(this,e,t)},u.prototype.createType=function(e){var t=this.model,r=this.properties,n=Object.create(c.prototype);o(e.properties,function(e){e.isMany||void 0===e.default||(n[e.name]=e.default)}),r.defineModel(n,t),r.defineDescriptor(n,e);var i=e.ns.name;function p(e){r.define(this,"$type",{value:i,enumerable:!0}),r.define(this,"$attrs",{value:{}}),r.define(this,"$parent",{writable:!0}),o(e,a(function(e,t){this.set(t,e)},this))}return p.prototype=n,p.hasType=n.$instanceOf=this.model.hasType,r.defineModel(p,t),r.defineDescriptor(p,e),p};var d={String:!0,Boolean:!0,Integer:!0,Real:!0,Element:!0},l={String:function(e){return e},Boolean:function(e){return"true"===e},Integer:function(e){return parseInt(e,10)},Real:function(e){return parseFloat(e)}};function h(e){return!!d[e]}function m(e,t){var r,n,i=e.split(/:/);if(1===i.length)r=e,n=t;else{if(2!==i.length)throw new Error("expected <prefix:localName> or <localName>, got "+e);r=i[1],n=i[0]}return{name:e=(n?n+":":"")+r,prefix:n,localName:r}}function g(e){this.ns=e,this.name=e.name,this.allTypes=[],this.allTypesByName={},this.properties=[],this.propertiesByName={}}function v(e,t){this.packageMap={},this.typeMap={},this.packages=[],this.properties=t,o(e,a(this.registerPackage,this))}function P(e,t,r){var n=t[r];if(n in e)throw new Error("package with "+r+" <"+n+"> already defined")}function w(e){this.model=e}function b(e,t,r){Object.defineProperty(e,t.name,{enumerable:!t.isReference,writable:!0,value:r,configurable:!0})}function N(e){this.properties=new w(this),this.factory=new u(this,this.properties),this.registry=new v(e,this.properties),this.typeCache={}}g.prototype.build=function(){return e=this,t=["ns","name","allTypes","allTypesByName","properties","propertiesByName","bodyProperty","idProperty"],r={},n=Object(e),o(t,function(t){t in n&&(r[t]=e[t])}),r;var e,t,r,n},g.prototype.addProperty=function(e,t,r){"boolean"==typeof t&&(r=t,t=void 0),this.addNamedProperty(e,!1!==r);var n=this.properties;void 0!==t?n.splice(t,0,e):n.push(e)},g.prototype.replaceProperty=function(e,t,r){var n=e.ns,i=this.properties,o=this.propertiesByName,p=e.name!==t.name;if(e.isId){if(!t.isId)throw new Error("property <"+t.ns.name+"> must be id property to refine <"+e.ns.name+">");this.setIdProperty(t,!1)}if(e.isBody){if(!t.isBody)throw new Error("property <"+t.ns.name+"> must be body property to refine <"+e.ns.name+">");this.setBodyProperty(t,!1)}var s=i.indexOf(e);if(-1===s)throw new Error("property <"+n.name+"> not found in property list");i.splice(s,1),this.addProperty(t,r?void 0:s,p),o[n.name]=o[n.localName]=t},g.prototype.redefineProperty=function(e,t,r){var n=e.ns.prefix,i=t.split("#"),o=m(i[0],n),p=m(i[1],o.prefix).name,s=this.propertiesByName[p];if(!s)throw new Error("refined property <"+p+"> not found");this.replaceProperty(s,e,r),delete e.redefines},g.prototype.addNamedProperty=function(e,t){var r=e.ns,n=this.propertiesByName;t&&(this.assertNotDefined(e,r.name),this.assertNotDefined(e,r.localName)),n[r.name]=n[r.localName]=e},g.prototype.removeNamedProperty=function(e){var t=e.ns,r=this.propertiesByName;delete r[t.name],delete r[t.localName]},g.prototype.setBodyProperty=function(e,t){if(t&&this.bodyProperty)throw new Error("body property defined multiple times (<"+this.bodyProperty.ns.name+">, <"+e.ns.name+">)");this.bodyProperty=e},g.prototype.setIdProperty=function(e,t){if(t&&this.idProperty)throw new Error("id property defined multiple times (<"+this.idProperty.ns.name+">, <"+e.ns.name+">)");this.idProperty=e},g.prototype.assertNotDefined=function(e,t){var r=e.name,n=this.propertiesByName[r];if(n)throw new Error("property <"+r+"> already defined; override of <"+n.definedBy.ns.name+"#"+n.ns.name+"> by <"+e.definedBy.ns.name+"#"+e.ns.name+"> not allowed without redefines")},g.prototype.hasProperty=function(e){return this.propertiesByName[e]},g.prototype.addTrait=function(e,t){var r=this.allTypesByName,n=this.allTypes,i=e.name;i in r||(o(e.properties,a(function(r){r=y({},r,{name:r.ns.localName,inherited:t}),Object.defineProperty(r,"definedBy",{value:e});var n=r.replaces,i=r.redefines;n||i?this.redefineProperty(r,n||i,n):(r.isBody&&this.setBodyProperty(r),r.isId&&this.setIdProperty(r),this.addProperty(r))},this)),n.push(e),r[i]=e)},v.prototype.getPackage=function(e){return this.packageMap[e]},v.prototype.getPackages=function(){return this.packages},v.prototype.registerPackage=function(e){e=y({},e);var t=this.packageMap;P(t,e,"prefix"),P(t,e,"uri"),o(e.types,a(function(t){this.registerType(t,e)},this)),t[e.uri]=t[e.prefix]=e,this.packages.push(e)},v.prototype.registerType=function(e,t){var r=m((e=y({},e,{superClass:(e.superClass||[]).slice(),extends:(e.extends||[]).slice(),properties:(e.properties||[]).slice(),meta:y(e.meta||{})})).name,t.prefix),n=r.name,i={};o(e.properties,a(function(e){var t=m(e.name,r.prefix),n=t.name;h(e.type)||(e.type=m(e.type,t.prefix).name),y(e,{ns:t,name:n}),i[n]=e},this)),y(e,{ns:r,name:n,propertiesByName:i}),o(e.extends,a(function(e){var t=this.typeMap[e];t.traits=t.traits||[],t.traits.push(n)},this)),this.definePackage(e,t),this.typeMap[n]=e},v.prototype.mapTypes=function(e,t,r){var n=h(e.name)?{name:e.name}:this.typeMap[e.name],i=this;function p(e){return s(e,!0)}function s(r,n){var o=m(r,h(r)?"":e.prefix);i.mapTypes(o,t,n)}if(!n)throw new Error("unknown type <"+e.name+">");o(n.superClass,r?p:s),t(n,!r),o(n.traits,p)},v.prototype.getEffectiveDescriptor=function(e){var t=m(e),r=new g(t);this.mapTypes(t,function(e,t){r.addTrait(e,t)});var n=r.build();return this.definePackage(n,n.allTypes[n.allTypes.length-1].$pkg),n},v.prototype.definePackage=function(e,t){this.properties.define(e,"$pkg",{value:t})},w.prototype.set=function(e,t,r){if(!n(t)||!t.length)throw new TypeError("property name must be a non-empty string");var i=this.model.getPropertyDescriptor(e,t),o=i&&i.name;void 0===r?i?delete e[o]:delete e.$attrs[t]:i?o in e?e[o]=r:b(e,i,r):e.$attrs[t]=r},w.prototype.get=function(e,t){var r=this.model.getPropertyDescriptor(e,t);if(!r)return e.$attrs[t];var n=r.name;return!e[n]&&r.isMany&&b(e,r,[]),e[n]},w.prototype.define=function(e,t,r){if(!r.writable){var n=r.value;delete(r=y({},r,{get:function(){return n}})).value}Object.defineProperty(e,t,r)},w.prototype.defineDescriptor=function(e,t){this.define(e,"$descriptor",{value:t})},w.prototype.defineModel=function(e,t){this.define(e,"$model",{value:t})},N.prototype.create=function(e,t){var r=this.getType(e);if(!r)throw new Error("unknown type <"+e+">");return new r(t)},N.prototype.getType=function(e){var t=this.typeCache,r=n(e)?e:e.ns.name,i=t[r];return i||(e=this.registry.getEffectiveDescriptor(r),i=t[r]=this.factory.createType(e)),i},N.prototype.createAny=function(e,r,n){var i=m(e),p={$type:e,$instanceOf:function(e){return e===this.$type}},s={name:e,isGeneric:!0,ns:{prefix:i.prefix,localName:i.localName,uri:r}};return this.properties.defineDescriptor(p,s),this.properties.defineModel(p,this),this.properties.define(p,"$parent",{enumerable:!1,writable:!0}),this.properties.define(p,"$instanceOf",{enumerable:!1,writable:!0}),o(n,function(e,r){var n;n=e,"[object Object]"===t.call(n)&&void 0!==e.value?p[e.name]=e.value:p[r]=e}),p},N.prototype.getPackage=function(e){return this.registry.getPackage(e)},N.prototype.getPackages=function(){return this.registry.getPackages()},N.prototype.getElementDescriptor=function(e){return e.$descriptor},N.prototype.hasType=function(e,t){return void 0===t&&(t=e,e=this),t in e.$model.getElementDescriptor(e).allTypesByName},N.prototype.getPropertyDescriptor=function(e,t){return this.getElementDescriptor(e).propertiesByName[t]},N.prototype.getTypeDescriptor=function(e){return this.registry.typeMap[e]},e.Moddle=N,e.coerceType=function(e,t){var r=l[e];return r?r(t):t},e.isBuiltInType=h,e.isSimpleType=function(e){return!!l[e]},e.parseNameNS=m,Object.defineProperty(e,"__esModule",{value:!0})});
